<%= form_for([@review, @feedback]) do |f| %>
  <% if @feedback.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@feedback.errors.count, "error") %> prohibited this feedback from being saved:</h2>

      <ul>
      <% @feedback.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <label id="instructions-label">Click to view instructions.</label><br/><br/>

  <div id="instructions">
    <p><a href="https://docs.google.com/a/thoughtworks.com/spreadsheet/ccc?key=0AjfbOrpXgxXYdC0yWldQdjVFTEJlcldLc2JpZVBNVWc&hl=en_US#gid=0">See example feedback here</a></p>

    <p>For each section, please read the detailed description in the section header.
    This will give you more detail for the specific aspects of the individuals performance to consider for evaluation in the section.</p>

    <p>Updates to the feedback form will be autosaved every five seconds.  Text will turn grey when it matches the most recent autosave.</p>

    <p>There are three categories to organize your detailed feedback for each of the overall
    Sections. If you find the individual you are reviewing falls under two categories (perhaps both Meeting
    &amp; Exceeding expectations) for a given section, please include both responses. There is no need to include
    responses in all categories, if it does not apply.</p>
  </div>

  <br />
  <div class="row-fluid">
    <div class="span3">
      <div class="field">
        <%= f.label "Feedback by" %>
        <% if not additional %>
          <%= @user_name %>
        <% else %>
          <%= f.text_field :user_string %>
        <% end %>
      </div>

      <div class="field">
        <%= f.label :project_worked_on %><br />
        <%= f.text_field :project_worked_on %>
      </div>

      <div class="field">
        <%= f.label :feedback_deadline %><br />
        <%= f.text_field :feedback_deadline, :value => @review.feedback_deadline, :disabled => true%>
      </div>

      <div class="field">
        <%= f.label :role_description %><br />
        <%= f.text_field :role_description %>
      </div>
    </div>

  <div class="span9">
  <div id="accordion">
    <% @review.headings.each do |heading| %>
      <h3><%= @review.heading_title(heading) %></h3>
      <div>
        <%= raw @review.description(heading) %>

        <% @review.fields_for_heading(heading).each do |field| %>
          <div class="field">
            <%= f.label field %><br />
            <%= f.text_area field %>
          </div>
        <% end %>
        <% if @review.has_scale(heading) %>
          <div class="scale">
            <%= f.label "Please use a scale to prioritze areas you feel the reviewee should focus." %>
            <%= f.select @review.scale_field(heading), feedback_priorities, :include_blank => "Select a scale" %>
          </div>
        <% end %>
      </div>
    <% end %>


    <h3>General Comments</h3>
    <div>
      <p>Anything not covered above</p>
      <div class="field">
        <%= f.label :comments %><br />
        <%= f.text_area :comments %>
      </div>
    </div>
  </div>
  <br /><br />
  <p>Any feedback you type in the box will be autosaved roughly every five seconds.  The text in the field will turn grey when the autosave is current.<br />
  Clicking on the 'Submit Final' will indicate that you are done writing the feedback, and that it can be shared</p>
  <div class="actions">
    <%= f.submit 'Submit Final', {:class => "submit_feedback_button", :name => "submit_final_button", :confirm => 'Once Submitted, you cannot change this feedback' } %>
    <% if not @feedback.new_record? %>
    <%= f.submit 'Delete Feedback', {:class => "delete_feedback_button", :name => "delete_feedback_button", :confirm => 'Are you sure you want to delete this feedback?'}  %>
    <% end %>

  </div>
  </div>
</div>
<% end %>
<script>

  $('#instructions-label').click(function() {
    $('#instructions').slideToggle();
  });



  var autosave = false;
  window.setInterval(function () {
    var url = document.location.pathname.split('/').slice(0, -1).join('/') + ".json";
      if (autosave) {
          $.ajax({
              type: "PUT",
              url: url,
              data: $($('.edit_feedback')[0]).serialize(),
              success: function () { return false; }
          });
          $('textarea').css("color", "rgb(160, 160, 160)");
          autosave = false;
      }
  }, 5000);

  $('textarea').bind('input propertychange', function () {
    $(':focus').css("color", "rgb(30, 30, 30))");
      autosave = true;
  });

</script>
